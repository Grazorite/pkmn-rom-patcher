name: Validate ROM Hack Submission

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'metadata/**'
      - 'patches/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          
      - name: Analyze PR type
        id: analyze
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          node scripts/pr-analyzer.js
          
      - name: Skip validation for development PRs
        if: steps.analyze.outputs.should_validate != 'true'
        run: |
          echo "Skipping validation - this appears to be a development PR"
          echo "PR Type: ${{ steps.analyze.outputs.pr_type }}"
          exit 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Validate metadata files
        if: steps.analyze.outputs.should_validate == 'true'
        run: |
          echo "Validating metadata files..."
          
          # Find all JSON files in metadata directory
          for file in metadata/**/*.json; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              
              # Check if valid JSON
              if ! jq empty "$file" 2>/dev/null; then
                echo "‚ùå Invalid JSON in $file"
                exit 1
              fi
              
              # Check required fields
              if ! jq -e '.id' "$file" >/dev/null; then
                echo "‚ùå Missing 'id' field in $file"
                exit 1
              fi
              
              if ! jq -e '.title' "$file" >/dev/null; then
                echo "‚ùå Missing 'title' field in $file"
                exit 1
              fi
              
              if ! jq -e '.meta.baseRom' "$file" >/dev/null; then
                echo "‚ùå Missing 'meta.baseRom' field in $file"
                exit 1
              fi
              
              if ! jq -e '.meta.author' "$file" >/dev/null; then
                echo "‚ùå Missing 'meta.author' field in $file"
                exit 1
              fi
              
              echo "‚úÖ $file is valid"
            fi
          done
          
      - name: Validate patch files
        if: steps.analyze.outputs.should_validate == 'true'
        run: |
          echo "Validating patch files..."
          
          # Check patch files exist and have valid extensions
          for file in patches/**/*; do
            if [ -f "$file" ]; then
              ext="${file##*.}"
              if [[ ! "$ext" =~ ^(ips|bps|ups|xdelta)$ ]]; then
                echo "‚ùå Invalid patch file extension: $file"
                exit 1
              fi
              
              # Check file size (max 10MB)
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ "$size" -gt 10485760 ]; then
                echo "‚ö†Ô∏è  Warning: $file is larger than 10MB"
              fi
              
              echo "‚úÖ $file is valid"
            fi
          done
          
      - name: Check for duplicates
        if: steps.analyze.outputs.should_validate == 'true'
        run: |
          echo "Checking for duplicate submissions..."
          
          # Check if ID already exists in manifest
          for file in metadata/**/*.json; do
            if [ -f "$file" ]; then
              id=$(jq -r '.id' "$file")
              count=$(grep -c "\"id\": \"$id\"" docs/manifest.json || true)
              if [ "$count" -gt 0 ]; then
                echo "‚ö†Ô∏è  Warning: ID '$id' already exists in manifest"
              fi
            fi
          done
          
      - name: Comment on PR
        if: always() && steps.analyze.outputs.should_validate == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üéÆ ROM Hack Submission Validation\n\n';
            
            if (context.payload.pull_request) {
              comment += '‚úÖ All validation checks passed!\n\n';
              comment += '### Next Steps\n';
              comment += '- A maintainer will review your submission\n';
              comment += '- Once approved, your ROM hack will be added to the library\n';
              comment += '- You will be notified when the PR is merged\n';
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
