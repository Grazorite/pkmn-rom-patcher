name: Validate Patch Naming

on:
  pull_request:
    paths:
      - 'patches/**'
      - 'metadata/**'

jobs:
  validate-naming:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Analyze PR type
        id: analyze
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          node scripts/pr-analyzer.js
          
      - name: Skip validation for development PRs
        if: steps.analyze.outputs.should_validate != 'true'
        run: |
          echo "Skipping naming validation - this appears to be a development PR"
          exit 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.analyze.outputs.should_validate == 'true'
        run: |
          pip install pyyaml

      - name: Validate patch naming
        if: steps.analyze.outputs.should_validate == 'true'
        id: validate
        run: |
          python scripts/validate_filenames.py --pr --json > validation_result.json
          cat validation_result.json

      - name: Generate PR comment
        if: always() && steps.analyze.outputs.should_validate == 'true'
        run: |
          python -c "
          import json
          
          with open('validation_result.json') as f:
              result = json.load(f)
          
          if result['valid']:
              comment = '''## üè∑Ô∏è Filename Validation Report
          
          ‚úÖ **All filenames follow the naming convention!**
          
          No issues detected.'''
          else:
              issues = result['issues']
              comment = f'''## üè∑Ô∏è Filename Validation Report
          
          ‚ö†Ô∏è **Non-compliant filenames detected ({len(issues)})**
          
          | Current Filename | Expected Filename | Metadata |
          |------------------|-------------------|----------|'''
              
              for issue in issues:
                  comment += f'''
          | \`{issue['current']}\` | \`{issue['expected']}\` | \`{issue['metadata']}\` |'''
              
              comment += '''
          
          ### üìã How to fix
          
          Run the rename script locally:
          \`\`\`bash
          python scripts/rename_patches.py --apply
          git add patches/ metadata/
          git commit -m \"chore: standardize patch filenames\"
          git push
          \`\`\`
          
          **Note**: This check is informational only and will not block the PR merge.'''
          
          with open('pr_comment.md', 'w') as f:
              f.write(comment)
          "

      - name: Comment PR
        if: always() && steps.analyze.outputs.should_validate == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr_comment.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });